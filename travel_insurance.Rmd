---
title: "Analyzing Travel Insurance"
author: "Kah Jun Lim"
date: "10/2/2019"
output:
  github_document: default
  html_document:
    code_folding: hide
    number_sections: no
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The purpose of this project is to perform exploratory data analysis(EDA) on travel insurance dataset and identify factors that might affect whether a claim is made.

## Loading the Data and Dependencies

```{r Data and Dependencies, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(scales)
library(gridExtra)

travel_insurance_full <- read.csv("data/travel_insurance.csv")
head(travel_insurance_full)
```

```{r Rename columns}
colnames(travel_insurance_full) <- c("agency", "agency.type", "distribution.channel", "product.name", "claim", 
                                     "duration", "destination", "net.sales", "commision", "gender", "age")
```


## Exploratory Data Analysis

```{r Simple Statistics}
summary(travel_insurance_full)
```

There are 10 features in this data set, 4 of them are numeric and the others are factors. The only column with missing data is Gender, where a large portion of the values are missing. I notice that there are non-positive values for duration, which does not make sense. There are also durations that are excessively long. For age, the highest value is 118.

```{r Looking at bad data}
travel_insurance_full %>%
  filter(duration <= 0 | duration >= 1000) %>%
  nrow
travel_insurance_full %>%
  filter(age > 100) %>%
  nrow
```

Since there is only a relatively small proportion of the data contains unreasonable duration and uncommon age, I remove these data points for the purpose of this project.

```{r Preprocessing}
travel_insurance <- travel_insurance_full %>%
  filter(duration > 0 & duration < 1000 & age <= 100) %>%
  mutate(claim = ifelse(claim == "Yes", 1, 0))
levels(travel_insurance$gender) <- c("Unknown", "F", "M")
```

We can now move on to look at distribution of some of the features.

### Factor Variables

```{r Factor variables}
# agency.type
ggplot(travel_insurance, aes(x = claim, fill = agency.type)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent_format())

# distribution.channel (not useful)
# ggplot(travel_insurance, aes(x = claim, fill = distribution.channel)) +
#   geom_bar()

# gender
ggplot(travel_insurance, aes(x = claim, fill = gender)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent_format())

# Helper functions to plot top n for factors with many levels
plot_top_n <- function(df, var, n = 10, title = "") {
  colnames(df)[colnames(df) == var] <- "var"
  freq_by_var <- df %>%
    group_by(var, claim = as.factor(claim)) %>%
    summarise(freq = n()) %>%
    spread(key = claim, value = freq, fill = 0) %>%
    mutate(total = `0` + `1`) %>%
    ungroup %>%
    top_n(n = n, wt = total) %>%
    select(-total) %>%
    gather(key = "claim", value = "freq", `0`, `1`)
  p <- ggplot(freq_by_var, aes(x = var, y = freq, fill = claim))
  p1 <- p +
    geom_bar(stat = "identity") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab(var)
  p2 <- p +
    geom_bar(stat = "identity", position = "fill") +
    scale_y_continuous(labels = percent_format()) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab(var)
  grid.arrange(p1, p2, ncol = 2, top = title)
}

plot_top_n(travel_insurance, "destination", title = "Top 10 Destinations")
plot_top_n(travel_insurance, "agency", title = "Top 10 Agencies")
plot_top_n(travel_insurance, "product.name", title = "Top 10 Products")
```

1.  We see that given a claim has occured, it is more likely to be from airlines than from travel agency. 

2.  For gender, although claims occur with equal proportion for Male, Female and Unknown.

3.  Only 5 agencies observed claims count more than 50.

4. All the companies have extremely low percentage of claims observed.


### Numeric Variables
```{r Numeric variables}
p1 <- ggplot(travel_insurance, aes(x = duration, y = claim)) +
  geom_jitter(alpha = 0.05)
p2 <- ggplot(travel_insurance, aes(x = net.sales, y = claim)) +
  geom_jitter(alpha = 0.05)
p3 <- ggplot(travel_insurance, aes(x = commision, y = claim)) +
  geom_jitter(alpha = 0.05)
p4 <- ggplot(travel_insurance, aes(x = age, y = claim)) +
  geom_jitter(alpha = 0.05)
grid.arrange(p1, p2, p3, p4, ncol = 2)
```

There doesn't seem to be any obvious pattern in the four plots. Let us add more dimension to the scatterplots and see if we can have any new findings.

```{r Numeric Variables by Factors}
# duration
ggplot(travel_insurance, aes(x = duration, y = claim, color = gender)) +
  geom_jitter(alpha = 0.5, shape = 1)
ggplot(travel_insurance, aes(x = duration, y = claim, color = agency.type)) +
  geom_jitter(alpha = 0.5, shape = 1)

# age (not useful)
# ggplot(travel_insurance, aes(x = age, y = claim, color = gender)) +
#   geom_jitter(alpha = 0.5, shape = 1)
# ggplot(travel_insurance, aes(x = age, y = claim, color = agency.type)) +
#   geom_jitter(alpha = 0.5, shape = 1)

# net.sales
ggplot(travel_insurance, aes(x = net.sales, y = claim, color = gender)) +
  geom_jitter(alpha = 0.5, shape = 1)
ggplot(travel_insurance, aes(x = net.sales, y = claim, color = agency.type)) +
  geom_jitter(alpha = 0.5, shape = 1)

# commision (not useful)
# ggplot(travel_insurance, aes(x = commision, y = claim, color = gender)) +
#   geom_jitter(alpha = 0.5, shape = 1)
# ggplot(travel_insurance, aes(x = commision, y = claim, color = agency.type)) +
#   geom_jitter(alpha = 0.5, shape = 1)
```

TODO
